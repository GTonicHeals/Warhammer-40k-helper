@page "/core-rules"
@rendermode InteractiveServer
@using System.Xml
@using System.Xml.Linq
@using System.IO
@using System.Text.RegularExpressions
@inject IWebHostEnvironment Env

<PageTitle>Core Rulebook</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Core Rules Reference</h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-dark text-white"><i class="bi bi-search"></i></span>

                <input type="text"
                       class="form-control"
                       placeholder="Search rules (e.g. 'Tank Shock', 'Ruins', 'Stealth')..."
                       @bind="searchTerm"
                       @bind:event="oninput" />

                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="btn btn-outline-secondary" @onclick="() => searchTerm = string.Empty">Clear</button>
                }
            </div>
            <small class="text-light">
                Status: @(string.IsNullOrEmpty(searchTerm) ? "Showing All" : $"Filtering for '{searchTerm}'")
            </small>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <span class="badge bg-secondary ms-2">@FilteredRules.Count() / @rules.Count Loaded</span>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-warning">Scanning Game System file...</p>
        </div>
    }
    else if (rules.Count == 0)
    {
        <div class="alert alert-danger">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>No Rules Loaded</h4>
            <p>Could not find any rules in <code>Warhammer 40,000.gst</code>.</p>
        </div>
    }
    else if (!FilteredRules.Any())
    {
        <div class="alert alert-warning">
            <i class="bi bi-search me-2"></i>No rules found matching "<strong>@searchTerm</strong>"
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 g-4">
            @foreach (var rule in FilteredRules)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm border-0 bg-dark text-light">
                        <div class="card-header border-bottom border-secondary">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <h5 class="card-title mb-0 text-warning">@rule.Name</h5>
                                <div>
                                    @{
                                        var badgeClass = rule.Category == "Stratagem" ? "bg-danger text-white" :
                                        rule.Category == "Core Rule" ? "bg-warning text-dark" :
                                        "bg-info text-dark";
                                    }
                                    <span class="badge @badgeClass me-1" style="font-size: 0.7rem;">@rule.Category</span>

                                    @if (!string.IsNullOrEmpty(rule.Page))
                                    {
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">Pg @rule.Page</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text small" style="white-space: pre-wrap; color: #d1d1d1;">
                                @((MarkupString)FormatBattleScribeText(rule.Description))
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Rule> rules = new();
    private string searchTerm = "";
    private bool isLoading = true;

    private IEnumerable<Rule> FilteredRules =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? rules
            : rules.Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                               r.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await Task.Run(() =>
        {
            var filePath = Path.Combine(Env.WebRootPath, "data", "Warhammer 40,000.gst");
            if (File.Exists(filePath))
            {
                rules = StreamRulesFromFile(filePath);
            }
        });

        isLoading = false;
    }

    private List<Rule> StreamRulesFromFile(string path)
    {
        var foundRules = new List<Rule>();

        try
        {
            using var reader = XmlReader.Create(path, new XmlReaderSettings { IgnoreWhitespace = true });
            reader.MoveToContent();

            while (reader.Read())
            {
                if (reader.NodeType != XmlNodeType.Element) continue;

                if (reader.LocalName == "rule")
                {
                    if (reader.GetAttribute("hidden") == "true") continue;

                    var el = (XElement)XNode.ReadFrom(reader);

                    var name = el.Attribute("name")?.Value;
                    var page = el.Attribute("page")?.Value;
                    var desc = el.Descendants().FirstOrDefault(x => x.Name.LocalName == "description")?.Value;

                    if (!string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(desc))
                    {
                        foundRules.Add(new Rule
                        {
                            Name = name,
                            Page = page ?? "",
                            Description = desc,
                            Category = "Core Rule"
                        });
                    }
                }
                else if (reader.LocalName == "profile")
                {
                    if (reader.GetAttribute("hidden") == "true") continue;

                    var typeName = reader.GetAttribute("typeName");

                    if (typeName != "Abilities" &&
                        typeName != "Rule" &&
                        typeName != "Crusade Relic" &&
                        typeName != "Crusade Battle Trait" &&
                        typeName != "Crusade Battle Scar" &&
                        typeName != "Weapon Ability" &&
                        typeName != "Stratagem" &&    
                        typeName != "Mission Rule" && 
                        typeName != "Terrain")        
                        continue;

                    var el = (XElement)XNode.ReadFrom(reader);

                    var name = el.Attribute("name")?.Value;
                    var page = el.Attribute("page")?.Value;

                    var desc = el.Descendants()
                                 .FirstOrDefault(x => x.Name.LocalName == "characteristic" &&
                                                      x.Attribute("name")?.Value == "Description")?.Value;

                    if (!string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(desc))
                    {
                        foundRules.Add(new Rule
                        {
                            Name = name,
                            Page = page ?? "",
                            Description = desc,
                            Category = typeName ?? "Ability"
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error streaming XML: {ex.Message}");
        }

        return foundRules
            .OrderBy(r => r.Name)
            .DistinctBy(r => r.Name)
            .ToList();
    }

    private string FormatBattleScribeText(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        var text = input;

        text = Regex.Replace(text, @"\*\*(.*?)\*\*", "<strong class='text-white'>$1</strong>");
        text = Regex.Replace(text, @"\^\^(.*?)\^\^", "<em class='text-info fw-bold'>$1</em>");
        text = text.Replace("•", "<br/>•");
        text = text.Replace("\n", "<br/>");

        return text;
    }

    public class Rule
    {
        public string Name { get; set; } = "";
        public string Page { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
    }
}