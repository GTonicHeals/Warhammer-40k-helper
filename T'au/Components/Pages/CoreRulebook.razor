@page "/core-rules"
@using System.Xml.Serialization
@using System.IO
@using System.Text.RegularExpressions
@inject IWebHostEnvironment Env

<PageTitle>Core Rulebook</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Core Rules Reference</h1>
            <p class="text-muted">sourced from Warhammer 40,000.gst</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text"
                   class="form-control form-control-lg"
                   placeholder="Search rules (e.g. 'Deep Strike')..."
                   @bind="searchTerm"
                   @bind:event="oninput" />
        </div>
    </div>

    @if (rules == null)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!FilteredRules.Any())
    {
        <div class="alert alert-warning">No rules found matching "@searchTerm"</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 g-4">
            @foreach (var rule in FilteredRules)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">@rule.Name</h5>
                            @if (!string.IsNullOrEmpty(rule.Page))
                            {
                                <span class="badge bg-secondary">Pg @rule.Page</span>
                            }
                        </div>
                        <div class="card-body">
                            <p class="card-text" style="white-space: pre-wrap;">
                                @((MarkupString)FormatBattleScribeText(rule.Description))
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Rule>? rules;
    private string searchTerm = "";

    private IEnumerable<Rule> FilteredRules =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? (rules ?? new List<Rule>())
            : rules.Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                               r.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        // Adjust this path to where you stored the .gst file
        var filePath = Path.Combine(Env.WebRootPath, "data", "Warhammer 40,000.gst");

        if (File.Exists(filePath))
        {
            rules = ParseGstFile(filePath);
        }
    }

    // --- XML Parsing Logic ---
    private List<Rule> ParseGstFile(string path)
    {
        try
        {
            var serializer = new XmlSerializer(typeof(GameSystem));
            using var stream = new FileStream(path, FileMode.Open);
            var system = (GameSystem?)serializer.Deserialize(stream);

            return system?.SharedRules?.Rules.OrderBy(r => r.Name).ToList() ?? new List<Rule>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing GST: {ex.Message}");
            return new List<Rule>();
        }
    }

    // --- Helper to format BattleScribe specific markup ---
    // Example: Converts **[KEYWORD]** to bold and ^^Unit^^ to italic/bold
    private string FormatBattleScribeText(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;

        // Replace **Text** with <strong>Text</strong>
        var boldRegex = new Regex(@"\*\*(.*?)\*\*");
        var result = boldRegex.Replace(input, "<strong>$1</strong>");

        // Replace ^^Text^^ with <em><strong>Text</strong></em> (often used for keywords like ^^Character^^)
        var keywordRegex = new Regex(@"\^\^(.*?)\^\^");
        result = keywordRegex.Replace(result, "<em class='text-primary fw-bold'>$1</em>");

        // Replace newlines with <br> for HTML display
        result = result.Replace("\n", "<br/>");

        return result;
    }

    // --- XML Mapping Models ---

    [XmlRoot("gameSystem", Namespace = "http://www.battlescribe.net/schema/gameSystemSchema")]
    public class GameSystem
    {
        [XmlElement("sharedRules")]
        public SharedRules? SharedRules { get; set; }
    }

    public class SharedRules
    {
        [XmlElement("rule")]
        public List<Rule> Rules { get; set; } = new();
    }

    public class Rule
    {
        [XmlAttribute("name")]
        public string Name { get; set; } = "";

        [XmlAttribute("page")]
        public string Page { get; set; } = "";

        [XmlElement("description")]
        public string Description { get; set; } = "";
    }
}