@page "/tau-rules"
@rendermode InteractiveServer
@using System.Xml
@using System.Xml.Linq
@using System.IO
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
@inject HttpClient Http

<PageTitle>T'au Empire Reference</PageTitle>

<div class="rules-container">
    <h1 class="page-title">T'au Empire Rules Reference</h1>

    <div class="rule-card army-rule">
        <div class="rule-header">
            <i class="bi bi-crosshair me-2"></i> FACTION RULE: For The Greater Good
        </div>
        <div class="rule-body">
            <p>
                If your Army Faction is <strong>T'au Empire</strong>, at the start of your <strong>Shooting phase</strong>,
                you can select units from your army with this ability to become <strong>Observer units</strong>.
            </p>

            <div class="ftgg-diagram">
                <div class="step">
                    <span class="badge bg-secondary">1</span>
                    <strong>Select Observer</strong>
                    <small>Must have Line of Sight to Target</small>
                </div>
                <div class="arrow">➜</div>
                <div class="step">
                    <span class="badge bg-danger">2</span>
                    <strong>Select Guided Unit</strong>
                    <small>Must shoot the SAME Target</small>
                </div>
            </div>

            <ul class="bonus-list">
                <li class="good">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Guided Unit:</strong> Improves <strong>Ballistic Skill</strong> by 1 when shooting the Spotted unit.
                </li>
                <li class="good">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Markerlight Keyword:</strong> If Observer has <em>Markerlight</em>, the Guided unit also ignores <strong>Cover</strong>.
                </li>
            </ul>
        </div>
    </div>

    <div class="rule-card detachment-rule">
        <div class="rule-header">
            <i class="bi bi-diagram-3 me-2"></i> DETACHMENT: Kauyon
        </div>
        <div class="rule-body">
            <p><strong>Patient Hunter:</strong> From Battle Round 3 onwards, ranged weapons equipped by T'au Empire models from your army have the <strong>[SUSTAINED HITS 1]</strong> ability.</p>
            <div class="alert alert-dark mt-2" style="border: 1px solid #444;">
                <strong>[SUSTAINED HITS 1]:</strong> A Critical Hit (unmodified roll of 6) generates 1 additional hit.
            </div>
            <p class="mt-2 text-muted">
                <em>*If the unit is a Guided unit (see above), rolls of 6 score [SUSTAINED HITS 2] instead.</em>
            </p>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="text-warning fw-bold">Full Rules Database</h2>
            <p class="text-light">Search Stratagems, Enhancements, and Datasheet Abilities</p>
        </div>
    </div>

    <div class="row mb-4 justify-content-center">
        <div class="col-md-8">
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-dark text-warning border-warning"><i class="bi bi-search"></i></span>
                <input type="text"
                       class="form-control bg-dark text-light border-warning"
                       placeholder="Search (e.g. 'Strike and Fade', 'Stimulant Injectors')..."
                       @bind="searchTerm"
                       @bind:event="oninput" />
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <button class="btn btn-outline-warning" @onclick="() => searchTerm = string.Empty">Clear</button>
                }
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-warning" role="status"></div>
        </div>
    }
    else if (!FilteredRules.Any())
    {
        <div class="alert alert-dark text-center border-warning">
            <span class="text-warning">No results found for "@searchTerm"</span>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 g-4 pb-5">
            @foreach (var rule in FilteredRules)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm bg-dark text-light border-secondary">
                        <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 text-warning">@rule.Name</h5>
                            <span class="badge @GetBadgeClass(rule.Category)">@rule.Category</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text small" style="white-space: pre-wrap; color: #e0e0e0;">
                                @((MarkupString)FormatText(rule.Description))
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Rule> rules = new();
    private string searchTerm = "";
    private bool isLoading = true;

    private IEnumerable<Rule> FilteredRules =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? rules
            : rules.Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                               r.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // We fetch the file as a data stream over the network
            using var stream = await Http.GetStreamAsync("data/T'au Empire.cat");
            rules = StreamTauRules(stream);
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Could not find rules file: {ex.Message}");
            // Handle 404 - maybe clear the list or show an error
            rules = new List<Rule>();
        }

        isLoading = false;
    }

    // 1. Change the parameter type from 'string' to 'Stream'
    private List<Rule> StreamTauRules(Stream stream)
    {
        var found = new List<Rule>();
        try
        {
            // 2. Pass the stream directly to XmlReader
            using var reader = XmlReader.Create(stream, new XmlReaderSettings { IgnoreWhitespace = true });
            reader.MoveToContent();

            while (reader.Read())
            {
                if (reader.NodeType != XmlNodeType.Element) continue;

                // ... (Your parsing logic remains exactly the same below) ...

                // 1. Army Rules
                if (reader.LocalName == "rule")
                {
                    if (reader.GetAttribute("hidden") == "true") continue;
                    // Read the current element (XNode.ReadFrom advances the reader)
                    var el = (XElement)XNode.ReadFrom(reader);

                    var name = el.Attribute("name")?.Value;
                    var desc = el.Descendants().FirstOrDefault(x => x.Name.LocalName == "description")?.Value;

                    if (!string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(desc))
                        found.Add(new Rule { Name = name, Description = desc, Category = "Army Rule" });
                }
                // 2. Profiles (Stratagems, Enhancements)
                else if (reader.LocalName == "profile")
                {
                    var type = reader.GetAttribute("typeName");
                    if (type != "Stratagem" && type != "Abilities" && type != "Enhancement") continue;

                    var el = (XElement)XNode.ReadFrom(reader);
                    var name = el.Attribute("name")?.Value;

                    // Note: Ensure your XML structure matches this query
                    var desc = el.Descendants()
                                 .FirstOrDefault(x => x.Name.LocalName == "characteristic" &&
                                                      x.Attribute("name")?.Value == "Description")?.Value;

                    if (!string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(desc))
                        found.Add(new Rule { Name = name, Description = desc, Category = type });
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing XML: {ex.Message}");
        }

        return found.OrderBy(r => r.Name).ToList();
    }

    // --- BADGE STYLING LOGIC ---
    private string GetBadgeClass(string category)
    {
        // Normalize checking to be case-insensitive just in case
        if (category.Equals("Stratagem", StringComparison.OrdinalIgnoreCase))
            return "bg-tau-strat";

        if (category.Equals("Enhancement", StringComparison.OrdinalIgnoreCase))
            return "bg-tau-enhancement";

        return "bg-tau-rule";
    }

    private string FormatText(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        var text = input.Replace("\n", "<br/>");

        // 1. Handle **Bold** text
        text = Regex.Replace(text, @"\*\*(.*?)\*\*", "<strong>$1</strong>");

        // 2. Handle ^^Keyword^^ text (Blue/Cyan style)
        // This regex captures text between ^^ and ^^ and wraps it in a styled span
        text = Regex.Replace(text, @"\^\^(.*?)\^\^", "<span class='text-warning fw-bold'>$1</span>");

        return text;
    }

    public class Rule
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
    }
}

<style>
    /* GLOBAL STYLES */
    .rules-container {
        max-width: 1000px;
        margin: 0 auto;
        color: #e0e0e0;
    }

    .page-title {
        color: #d35400;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    /* --- RULE CARDS --- */
    .rule-card {
        background: #242424;
        border: 1px solid #444;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .rule-header {
        padding: 10px 15px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .army-rule .rule-header {
        background: #d35400;
        color: white;
    }

    .detachment-rule .rule-header {
        background: #555;
        color: white;
        border-left: 5px solid #d35400;
    }

    .rule-body {
        padding: 15px;
    }

    /* Diagram for Greater Good */
    .ftgg-diagram {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: rgba(0,0,0,0.3);
        padding: 15px;
        margin: 15px 0;
        border-radius: 6px;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .arrow {
        font-size: 1.5rem;
        color: #777;
    }

    .bonus-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
    }

        .bonus-list li {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

    .good {
        border-left: 4px solid #27ae60;
    }

    /* --- TAU SPECIFIC COLORS & BADGES --- */
    .border-warning {
        border-color: #d35400 !important;
    }

    .text-warning {
        color: #d35400 !important;
    }

    .btn-outline-warning {
        color: #d35400;
        border-color: #d35400;
    }

        .btn-outline-warning:hover {
            background-color: #d35400;
            color: white;
        }

    /* STRATAGEM BADGE - Red/Orange */
    .bg-tau-strat {
        background-color: #d35400 !important;
        color: white !important;
    }

    /* ENHANCEMENT BADGE - Gold/Yellow */
    .bg-tau-enhancement {
        background-color: #f39c12 !important;
        color: black !important;
    }

    /* GENERIC RULE BADGE - Blue-Grey */
    .bg-tau-rule {
        background-color: #2c3e50 !important;
        color: white !important;
        border: 1px solid #d35400;
    }
</style>