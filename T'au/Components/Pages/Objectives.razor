@page "/objectives/{Side?}"
@rendermode InteractiveServer
@inject ObjectiveService ObjService

<div class="header-container">
    <div class="header-left">
        <h3>@(Side == "p2" ? "Player 2 Objectives" : "Player 1 Objectives")</h3>
    </div>
    <div class="cp-badge" style="color: @(Side == "p2" ? "#5dade2" : "#d35400")">
        <span class="text-muted">Cards in Deck:</span> @CurrentState.Deck.Count
    </div>
</div>

<div class="controls mb-4">
    @if (CurrentState.ActiveMissions.Count < 2)
    {
        <button class="btn btn-lg w-100 mb-2"
                style="border-color: @(Side == "p2" ? "#5dade2" : "#d35400"); color: @(Side == "p2" ? "#5dade2" : "#d35400");"
                @onclick="DrawCard">
            <i class="bi bi-stack me-2"></i>Draw Objective
        </button>
    }

    @if (CurrentState.ActiveMissions.Count > 0)
    {
        <button class="btn btn-sm btn-outline-secondary w-100" @onclick="ResetDeck">
            <i class="bi bi-arrow-counterclockwise me-2"></i>Reset Deck
        </button>
    }
</div>

<div class="mission-grid">
    @if (CurrentState.ActiveMissions.Count == 0)
    {
        <div class="empty-state">
            <i class="bi bi-layers text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No Active Missions</p>
            <small>Click "Draw" to generate secondary objectives.</small>
        </div>
    }
    else
    {
        @foreach (var mission in CurrentState.ActiveMissions)
        {
            <div class="mission-card @(Side == "p2" ? "p2-card" : "p1-card")">
                <div class="mission-header">
                    <span class="mission-title">@mission.Name</span>
                    <span class="mission-type">@mission.Type</span>
                </div>
                <div class="mission-body">
                    <p>@mission.Description</p>
                    <div class="vp-box">
                        <strong>Reward:</strong> @mission.Reward
                    </div>
                </div>
                <div class="mission-footer">
                    <button class="btn btn-sm btn-success flex-fill me-1" @onclick="() => ScoreMission(mission)">
                        <i class="bi bi-check-lg"></i> Score
                    </button>
                    <button class="btn btn-sm btn-danger flex-fill ms-1" @onclick="() => DiscardMission(mission)">
                        <i class="bi bi-x-lg"></i> Discard
                    </button>
                </div>
            </div>
        }
    }
</div>

@if (CurrentState.ScoredMissions.Any())
{
    <div class="mt-5">
        <h5 class="text-muted border-bottom pb-2">Completed Missions</h5>
        <ul class="list-unstyled text-white-50 small">
            @foreach (var m in CurrentState.ScoredMissions)
            {
                <li><i class="bi bi-check-circle-fill text-success me-2"></i>@m.Name</li>
            }
        </ul>
    </div>
}

@code {
    [Parameter]
    public string? Side { get; set; }

    // Helper property to access the correct state easily
    private PlayerState CurrentState => ObjService.GetState(Side ?? "p1");
    private Random Rnd = new Random();

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(Side)) Side = "p1";

        // Only reset if it has NEVER been used before
        if (!CurrentState.IsInitialized)
        {
            CurrentState.Reset();
        }
    }

    private void DrawCard()
    {
        if (CurrentState.Deck.Count == 0) return;

        int index = Rnd.Next(CurrentState.Deck.Count);
        var card = CurrentState.Deck[index];

        CurrentState.Deck.RemoveAt(index);
        CurrentState.ActiveMissions.Add(card);
    }

    private void ScoreMission(Objective m)
    {
        CurrentState.ActiveMissions.Remove(m);
        CurrentState.ScoredMissions.Add(m);
    }

    private void DiscardMission(Objective m)
    {
        CurrentState.ActiveMissions.Remove(m);
    }

    private void ResetDeck()
    {
        CurrentState.Reset();
    }
}

<style>
    .header-container {
        display: flex;
        justify-content: space-between;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .mission-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        min-height: 200px;
    }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        border: 2px dashed #444;
        padding: 40px;
        border-radius: 8px;
        color: #666;
    }

    /* GENERAL CARD STYLING */
    .mission-card {
        background: #e2e2e2;
        color: #222;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        border: 1px solid #999;
    }

    .mission-header {
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .mission-title {
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.9rem;
    }

    .mission-type {
        font-size: 0.7rem;
        opacity: 0.8;
        font-style: italic;
    }

    .mission-body {
        padding: 15px;
        flex-grow: 1;
        font-size: 0.9rem;
    }

    .vp-box {
        margin-top: 10px;
        background: rgba(0,0,0,0.1);
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        text-align: center;
    }

    .mission-footer {
        padding: 10px;
        background: #ccc;
        display: flex;
        justify-content: space-between;
    }

    /* --- THEMES --- */

    /* PLAYER 1 (ORANGE) */
    .p1-card .mission-header {
        background: #d35400;
    }

    .p1-card .vp-box {
        color: #d35400;
    }

    /* PLAYER 2 (BLUE) */
    .p2-card .mission-header {
        background: #2e86c1;
    }

    .p2-card .vp-box {
        color: #2e86c1;
    }
</style>