@page "/quickref"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject NavigationManager Nav
@using System.Text.RegularExpressions
@implements IDisposable

<div class="rules-container">

    <div class="header-section">
        <h1 class="page-title">Core Rules Reference</h1>
    </div>

    <div id="turn-sequence">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-header mb-0">Turn Sequence</h3>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("turn-sequence")'>Sequence</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("wound-calculator")'>Wounds</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("keywords")'>Keywords</button>
            </div>
        </div>

        <div class="phase-card command-phase">
            <div class="phase-header">
                <div class="phase-icon">I</div>
                <div class="phase-title">Command Phase</div>
            </div>
            <div class="phase-body">
                <div class="step-row">
                    <span class="step-num">1</span>
                    <div class="step-content">
                        <strong>Command Step</strong>
                        <p>Both players gain <strong>1 CP</strong>.</p>
                        <p>Resolve "Start of Command Phase" abilities.</p>
                    </div>
                </div>
                <div class="step-row">
                    <span class="step-num">2</span>
                    <div class="step-content">
                        <strong>Battle-shock Step</strong>
                        <p>Test for every unit <strong>Below Half-strength</strong>.</p>
                        <div class="mechanic-box" style="margin-bottom: 15px;">
                            <strong>Test:</strong> 2D6 ≥ Leadership (LD).<br />
                            <span class="text-danger">Fail:</span> OC = 0, No Stratagems, Desperate Escape on Fall Back.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="phase-card movement-phase">
            <div class="phase-header">
                <div class="phase-icon">II</div>
                <div class="phase-title">Movement Phase</div>
            </div>
            <div class="phase-body">
                <div class="step-row">
                    <span class="step-num">1</span>
                    <div class="step-content">
                        <strong>Move Units</strong>
                        <ul>
                            <li><strong>Normal:</strong> Move up to M".</li>
                            <li><strong>Advance:</strong> Move M + D6". <span class="text-warning">(No Shoot/Charge)</span></li>
                            <li><strong>Fall Back:</strong> Move M" (if in Engagement). <span class="text-warning">(No Shoot/Charge)</span></li>
                            <li><strong>Remain Stationary:</strong> Do not move.</li>
                        </ul>
                    </div>
                </div>
                <div class="step-row">
                    <span class="step-num">2</span>
                    <div class="step-content">
                        <strong>Reinforcements</strong>
                        <p>Set up Reserves / Deep Strike units (>9" from enemy).</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="phase-card shooting-phase">
            <div class="phase-header">
                <div class="phase-icon">III</div>
                <div class="phase-title">Shooting Phase</div>
            </div>
            <div class="phase-body">
                <div class="step-row">
                    <span class="step-num">1</span>
                    <div class="step-content">
                        <strong>Select Targets</strong>
                        <p>Must be <strong>Visible</strong> and within <strong>Range</strong>.</p>
                        <p><em>Lone Operative:</em> Can't be targeted >12".</p>
                    </div>
                </div>
                <div class="step-row">
                    <span class="step-num">2</span>
                    <div class="step-content">
                        <strong>Resolve Attacks</strong>
                        <div class="attack-sequence">
                            <span><strong>HIT:</strong> D6 vs BS</span> ➜
                            <span><strong>WOUND:</strong> D6 vs S/T</span> ➜
                            <span><strong>SAVE:</strong> D6 vs Sv</span> ➜
                            <span><strong>DAMAGE:</strong> Remove Wounds</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="phase-card charge-phase">
            <div class="phase-header">
                <div class="phase-icon">IV</div>
                <div class="phase-title">Charge Phase</div>
            </div>
            <div class="phase-body">
                <div class="step-row">
                    <span class="step-num">1</span>
                    <div class="step-content">
                        <strong>Charge Move</strong>
                        <p>Select target within 12". Roll <strong>2D6</strong>.</p>
                        <p>If roll allows ending within Engagement Range (1") of all targets, move unit.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="phase-card fight-phase">
            <div class="phase-header">
                <div class="phase-icon">V</div>
                <div class="phase-title">Fight Phase</div>
            </div>
            <div class="phase-body">
                <div class="alert alert-dark mb-3">
                    <strong>Fights First:</strong> Chargers & Abilities.<br />
                    <strong>Fights Normal:</strong> Everyone else.
                </div>
                <div class="step-row">
                    <span class="step-num">1</span>
                    <div class="step-content">
                        <strong>Sequence</strong>
                        <p>1. <strong>Pile In:</strong> Move 3" closer.</p>
                        <p>2. <strong>Attacks:</strong> Resolve Melee profiles.</p>
                        <p>3. <strong>Consolidate:</strong> Move 3" to engagement/objective.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="wound-calculator" class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-header mb-0">Wound Calculator</h3>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("turn-sequence")'>Sequence</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("wound-calculator")'>Wounds</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("keywords")'>Keywords</button>
            </div>
        </div>

        <div class="calc-box mb-4">
            <div class="row g-2 align-items-center justify-content-center">
                <div class="col-4 text-center">
                    <label class="calc-label">STR</label>
                    <input type="number" class="form-control calc-input" @bind="Strength" @bind:event="oninput" min="1" />
                </div>
                <div class="col-1 text-center text-warning fw-bold">VS</div>
                <div class="col-4 text-center">
                    <label class="calc-label">TGH</label>
                    <input type="number" class="form-control calc-input" @bind="Toughness" @bind:event="oninput" min="1" />
                </div>
            </div>

            <div class="result-display mt-3 @GetResultColor()">
                <span class="result-label">ROLL REQUIRED:</span>
                <span class="result-value">@CalculateRoll()+</span>
                <div class="result-reason">@GetResultReason()</div>
            </div>
        </div>
    </div>

    <div id="wound-chart" class="mt-5">
        <h3 class="section-header">Wound Roll Chart</h3>
        <div class="chart-card">
            <table class="chart-table">
                <thead>
                    <tr>
                        <th>Comparison</th>
                        <th>Required Roll</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="high-success">
                        <td>Strength is <strong>2x</strong> Toughness</td>
                        <td class="roll-val">2+</td>
                    </tr>
                    <tr class="med-success">
                        <td>Strength is <strong>Greater</strong> than Toughness</td>
                        <td class="roll-val">3+</td>
                    </tr>
                    <tr class="neutral">
                        <td>Strength is <strong>Equal</strong> to Toughness</td>
                        <td class="roll-val">4+</td>
                    </tr>
                    <tr class="med-fail">
                        <td>Strength is <strong>Less</strong> than Toughness</td>
                        <td class="roll-val">5+</td>
                    </tr>
                    <tr class="high-fail">
                        <td>Strength is <strong>Half</strong> Toughness</td>
                        <td class="roll-val">6+</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="keywords" class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-header mb-0">Universal Special Rules</h3>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("turn-sequence")'>Sequence</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("wound-calculator")'>Wounds</button>
                <button class="btn btn-outline-warning btn-sm" @onclick='() => ScrollTo("keywords")'>Keywords</button>
            </div>
        </div>

        <div class="input-group mb-3 sticky-search">
            <span class="input-group-text bg-dark text-white border-secondary"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control bg-dark text-white border-secondary"
                   placeholder="Search keywords..."
                   @bind="filterText"
                   @bind:event="oninput" />
        </div>

        <div class="keyword-grid">
            @foreach (var kw in FilteredKeywords)
            {
                <div class="keyword-card">
                    <div class="kw-header">
                        @((MarkupString)HighlightText(kw.Name))
                    </div>
                    <div class="kw-body">
                        @((MarkupString)HighlightText(kw.Definition))
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    window.quickRefState = {
        save: function (currentFilter) {
            sessionStorage.setItem('qr_filter', currentFilter);
        },
        load: function () {
            // Only returns the text, we ignore scrolling
            return sessionStorage.getItem('qr_filter') || "";
        },
        scrollToId: function(id) {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({ behavior: 'smooth' });
        }
    };
</script>

@code {
    private string filterText = "";

    // --- KEYWORDS DATA ---
    private List<KeywordDef> AllKeywords = new List<KeywordDef>
    {
        new KeywordDef("Anti-Keyword, X+", "CRITICAL WOUNDS the named unit type on X."),
        new KeywordDef("Assault", "Can Advance and Shoot."),
        new KeywordDef("Blast", "Add 1 attack per 5 models in target unit. No melee."),
        new KeywordDef("Conversion X", "Hit of 4+ is Critical if target > X\" away."),
        new KeywordDef("Critical Hits", "Unmodified Hit roll of 6. Always hits."),
        new KeywordDef("Critical Wounds", "Unmodified Wound roll of 6. Always wounds."),
        new KeywordDef("Deadly Demise X", "On death (roll 6), deals X Mortal Wounds to units within 6\"."),
        new KeywordDef("Deep Strike", "Set up in Reserves. Deploy >9\" from enemy."),
        new KeywordDef("Desperate Escape", "Fall Back check. Roll 1-2 = Model Destroyed."),
        new KeywordDef("Devastating Wounds", "Critical Wounds cause Mortal Wounds."),
        new KeywordDef("Extra Attacks", "Weapon attacks do not replace profile, they add to it."),
        new KeywordDef("Feel no pain, X+", "Ignore damage on a D6 roll of X+."),
        new KeywordDef("Fights First", "Unit fights before normal speed units."),
        new KeywordDef("Firing Deck-X", "Transport lets X models shoot out."),
        new KeywordDef("Fly", "Move over models/terrain vertically."),
        new KeywordDef("Grenades", "Keyword for Stratagem usage."),
        new KeywordDef("Hazardous", "After shooting, roll D6. On 1, model destroyed (or 3MW)."),
        new KeywordDef("Heavy", "+1 to Hit if unit remained stationary."),
        new KeywordDef("Ignores Cover", "Target gets no cover save bonus."),
        new KeywordDef("Indirect Fire", "Can shoot without line of sight. -1 Hit, Target gets Cover."),
        new KeywordDef("Infiltrators", "Deploy outside zone, >9\" from enemy."),
        new KeywordDef("Lance", "+1 to Wound on Charge."),
        new KeywordDef("Leader", "Attaches to bodyguard unit."),
        new KeywordDef("Lethal Hits", "Critical Hits automatically Wound."),
        new KeywordDef("Lone Operative", "Can't be shot >12\" away."),
        new KeywordDef("Melta X", "+X Damage at half range."),
        new KeywordDef("Objective Control (OC)", "Used to hold objectives."),
        new KeywordDef("One Shot", "Can only fire once per game."),
        new KeywordDef("Pistol", "Can shoot while in Engagement Range."),
        new KeywordDef("Precision", "Can target Character in attached unit."),
        new KeywordDef("Rapid Fire X", "+X Attacks at half range."),
        new KeywordDef("Scout X", "Pre-game move of X\"."),
        new KeywordDef("Smoke", "Keyword for Stratagem usage."),
        new KeywordDef("Stealth", "-1 to be Hit by ranged attacks."),
        new KeywordDef("Sustained Hits X", "Critical Hits generate X extra hits."),
        new KeywordDef("Torrent", "Auto-hits."),
        new KeywordDef("Twin-Linked", "Re-roll Wound rolls.")
    };

    private IEnumerable<KeywordDef> FilteredKeywords =>
        string.IsNullOrWhiteSpace(filterText)
        ? AllKeywords
        : AllKeywords.Where(k => k.Name.Contains(filterText, StringComparison.OrdinalIgnoreCase));

    public class KeywordDef
    {
        public string Name { get; set; }
        public string Definition { get; set; }
        public KeywordDef(string n, string d) { Name = n; Definition = d; }
    }

    // --- STATE LOGIC ---

    protected override async Task OnInitializedAsync()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Just load the filter text, don't scroll
            var savedFilter = await JS.InvokeAsync<string>("quickRefState.load");
            if (!string.IsNullOrEmpty(savedFilter))
            {
                filterText = savedFilter;
                StateHasChanged();
            }
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await JS.InvokeVoidAsync("quickRefState.save", filterText);
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
        _ = JS.InvokeVoidAsync("quickRefState.save", filterText);
    }

    private async Task ScrollTo(string id)
    {
        await JS.InvokeVoidAsync("quickRefState.scrollToId", id);
    }
    // --- CALCULATOR LOGIC ---
    private int Strength = 4;
    private int Toughness = 4;

    private int CalculateRoll()
    {
        if (Toughness == 0) return 0;
        if (Strength >= Toughness * 2) return 2;
        if (Strength > Toughness) return 3;
        if (Strength == Toughness) return 4;
        if (Strength <= Toughness / 2) return 6;
        return 5;
    }

    private string GetResultReason()
    {
        if (Strength >= Toughness * 2) return "Strength is 2x Toughness";
        if (Strength > Toughness) return "Strength > Toughness";
        if (Strength == Toughness) return "Strength = Toughness";
        if (Strength <= Toughness / 2) return "Strength is Half Toughness";
        return "Strength < Toughness";
    }

    private string GetResultColor()
    {
        return CalculateRoll() switch
        {
            2 => "res-green",
            3 => "res-teal",
            4 => "res-white",
            5 => "res-orange",
            6 => "res-red",
            _ => ""
        };
    }
    // --- HIGHLIGHT HELPER ---
    private string HighlightText(string text)
    {
        if (string.IsNullOrWhiteSpace(filterText)) return text;

        // Wraps matching text in a span with class 'highlight'
        return Regex.Replace(
            text,
            $"({Regex.Escape(filterText)})",
            "<span class='highlight'>$1</span>",
            RegexOptions.IgnoreCase
        );
    }
}


<style>
    /* CALCULATOR STYLES */
    .calc-box {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .calc-label {
        font-size: 0.75rem;
        font-weight: bold;
        color: #888;
        display: block;
        margin-bottom: 5px;
    }

    .calc-input {
        background: #333;
        border: 1px solid #555;
        color: white;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
    }

    .result-display {
        text-align: center;
        background: #111;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #333;
    }

    .result-value {
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1;
        display: block;
    }

    .result-reason {
        font-size: 0.8rem;
        font-style: italic;
        opacity: 0.8;
    }

    /* Result Colors */
    .res-green {
        color: #2ecc71;
        border-color: #2ecc71;
    }

    .res-teal {
        color: #1abc9c;
        border-color: #1abc9c;
    }

    .res-white {
        color: #ecf0f1;
        border-color: #7f8c8d;
    }

    .res-orange {
        color: #e67e22;
        border-color: #e67e22;
    }

    .res-red {
        color: #e74c3c;
        border-color: #e74c3c;
    }

    /* HIGHLIGHT STYLE */
    .highlight {
        background-color: #d35400;
        color: white;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: bold;
    }

    .rules-container {
        max-width: 900px;
        margin: 0 auto;
        padding-bottom: 80px;
        color: #e0e0e0;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
    }

    .page-title {
        color: #d35400;
        font-weight: 900;
        letter-spacing: 1px;
        margin: 0;
    }

    .section-header {
        color: #f39c12;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-left: 4px solid #d35400;
        padding-left: 10px;
    }

    /* --- CHART STYLES --- */
    .chart-card {
        background: #242424;
        border: 1px solid #444;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 40px;
    }

    .chart-table {
        width: 100%;
        border-collapse: collapse;
    }

        .chart-table th {
            background: #333;
            color: #d35400;
            padding: 12px;
            text-align: left;
            text-transform: uppercase;
            font-size: 0.9rem;
            border-bottom: 2px solid #555;
        }

        .chart-table td {
            padding: 15px;
            border-bottom: 1px solid #444;
            color: #e0e0e0;
        }

    .roll-val {
        font-size: 1.5rem;
        font-weight: 900;
        text-align: center;
        width: 80px;
    }

    .high-success .roll-val {
        color: #2ecc71;
    }

    .med-success .roll-val {
        color: #a2d9ce;
    }

    .neutral .roll-val {
        color: #fff;
    }

    .med-fail .roll-val {
        color: #e74c3c;
    }

    .high-fail .roll-val {
        color: #922b21;
    }

    /* --- PHASE CARDS --- */
    .phase-card {
        background: #242424;
        border: 1px solid #444;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .phase-header {
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .command-phase .phase-header {
        background: #c0392b;
        color: white;
    }

    .movement-phase .phase-header {
        background: #d35400;
        color: white;
    }

    .shooting-phase .phase-header {
        background: #27ae60;
        color: white;
    }

    .charge-phase .phase-header {
        background: #f39c12;
        color: #222;
    }

    .fight-phase .phase-header {
        background: #8e44ad;
        color: white;
    }

    .phase-body {
        padding: 15px;
        font-size: 0.95rem;
    }

    .step-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        border-bottom: 1px solid #333;
        padding-bottom: 12px;
    }

        .step-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

    .step-num {
        background: #333;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8rem;
        font-weight: bold;
        flex-shrink: 0;
    }

    .mechanic-box {
        background: rgba(0,0,0,0.3);
        border-left: 3px solid #c0392b;
        padding: 8px;
        margin-top: 5px;
        font-size: 0.9rem;
    }

    .attack-sequence {
        background: #111;
        padding: 8px;
        border-radius: 4px;
        margin-top: 5px;
        font-size: 0.85rem;
        color: #aaa;
    }

        .attack-sequence span {
            color: #eee;
        }

    .keyword-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
    }

    .keyword-card {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        overflow: hidden;
    }

    .kw-header {
        background: #333;
        color: #f39c12;
        padding: 6px 10px;
        font-weight: bold;
        font-size: 0.9rem;
        text-transform: uppercase;
        border-bottom: 1px solid #444;
    }

    .kw-body {
        padding: 10px;
        font-size: 0.9rem;
        color: #ccc;
        line-height: 1.4;
    }

    .sticky-search {
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
</style>